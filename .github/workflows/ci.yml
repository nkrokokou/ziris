name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend/zirist
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Detect frontend project
        id: detect
        run: |
          if [ -f package.json ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No package.json in $(pwd). Skipping frontend npm steps."
          fi
      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Debug Node env
        run: |
          node -v
          npm -v
          pwd
          ls -la
      - name: Configure npm (disable audit/fund)
        run: |
          npm config set fund false
          npm config set audit false
      - name: Inspect npm config and lockfile
        if: steps.detect.outputs.exists == 'true'
        run: |
          npm config list
          echo "--- lockfile (first 60 lines) ---"
          head -n 60 package-lock.json || true
      - name: Clean npm cache
        if: steps.detect.outputs.exists == 'true'
        run: npm cache clean --force
      - name: Install deps (verbose with fallbacks)
        if: steps.detect.outputs.exists == 'true'
        run: |
          set -e
          export CI=true
          npm config set legacy-peer-deps true
          npm ci --no-audit --no-fund --verbose \
            || npm ci --no-audit --no-fund --legacy-peer-deps --verbose \
            || npm install --no-audit --no-fund --legacy-peer-deps --verbose \
            || npm install --no-audit --no-fund --legacy-peer-deps --ignore-scripts --verbose
      - name: Lint
        if: steps.detect.outputs.exists == 'true'
        run: |
          if npm run 2>/dev/null | grep -qE '^\s*lint\s'; then
            npm run lint || exit 1
          else
            echo "No lint script, skipping"
          fi
      - name: Build
        if: steps.detect.outputs.exists == 'true'
        run: |
          export CI=false
          npm run build --if-present

  backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set PYTHONPATH for repo root
        run: echo "PYTHONPATH=${GITHUB_WORKSPACE}" >> $GITHUB_ENV
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies (if requirements.txt exists)
        run: |
          if [ -f backend/requirements.txt ]; then
            python -m pip install --upgrade pip
            pip install -r backend/requirements.txt
          else
            echo "No backend/requirements.txt found, skipping install"
          fi
      - name: Run tests (if tests folder exists)
        run: |
          if [ -d backend/tests ]; then
            pip install pytest
            pytest -q backend/tests
          else
            echo "No backend/tests found, skipping tests"
          fi
